<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/layout :: head">
<meta charset="utf-8">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</head>
<body>

	<header th:replace="layout/layout :: header"></header>
	<div th:replace="layout/layout :: alerts"></div>
	
	<br>
	
	<div class="container">
	   <div class="row">
	      <div class="col-lg-12 col-md-12 col-sm-12 container justify-content-center card">
	           <h1 class="text-center" th:text="${titulo}"></h1>
	           <div class="card-body">
	              <form th:action="${venta.id != null} ? @{/guardarVenta/{id}(id=${venta.id})} : @{/guardarVenta}" th:object="${venta}" method="post">
                 <input type="hidden" th:field="*{id}"/>
	                 <div class="form-group row">
                    <label for="buscar_cliente" class="col-sm-2 col-form-label">Buscar Cliente:</label>
                    <div class="col-sm-4">
                        <input type="text" id="buscar_cliente" class="form-control" th:value="${venta.cliente != null ? (venta.cliente.nombre + ' ' + (venta.cliente.apellido != null ? venta.cliente.apellido : '')) : ''}"/>
                        <input type="hidden" id="clienteId" name="clienteId" th:value="${venta.cliente != null ? venta.cliente.id : ''}"/>
                        <small id="cliente_seleccionado_msg" class="text-success font-weight-bold" style="display:none;">&#10003; Cliente seleccionado</small>
                    </div>
                    <div class="col-sm-2">
                        <button type="button" id="btn_buscar_cliente" class="btn btn-info">Buscar</button>
                    </div>
                 </div>
                 	                 <div id="resultados_busqueda_cliente" class="mb-3"></div>
                 
                                      <!-- Template hidden for JS cloning -->
                                      <div style="display:none;">
                                         <select id="listaPrecioTemplate" class="form-control lista_precio_item_select">
                                              <option th:each="lista : ${listasPrecio}" th:value="${lista.id}" th:text="${lista.nombre}"></option>
                                         </select>
                                      </div>
                 
                                      <hr/>
                     <div class="form-group row">
                        <label for="buscar_producto" class="col-sm-2 col-form-label">Buscar Producto:</label>
                        <div class="col-sm-4">
                            <input type="text" id="buscar_producto" class="form-control" placeholder="Nombre de vino o combo..."/>
                        </div>
                        <div class="col-sm-2">
                            <button type="button" id="btn_buscar_producto" class="btn btn-info">Buscar</button>
                        </div>
                     </div>

                     <div id="resultados_busqueda" class="mb-3"></div>

                    <table id="items_venta" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Lista Precio</th>
                                <th>Precio</th>
                                <th>Cantidad</th>
                                <th>Total</th>
                                <th>Eliminar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Existing Vinos -->
							<tr class="item_row" th:each="detalle : *{detalles}" th:if="${detalle.vino != null}">
								<td>
                                    <input type="hidden" name="item_id[]" th:value="${detalle.vino.id}" /> 
                                    <span class="badge badge-primary">Vino</span> <span th:text="${detalle.vino.nombre}"></span>
                                </td>
                                <td>
                                    <select name="lista_precio_item[]" class="form-control lista_precio_item_select">
                                        <option th:each="lista : ${listasPrecio}" 
                                                th:value="${lista.id}" 
                                                th:text="${lista.nombre}" 
                                                th:selected="${detalle.listaPrecio != null ? (detalle.listaPrecio.id == lista.id) : (venta.listaPrecio != null and venta.listaPrecio.id == lista.id)}">
                                        </option>
                                    </select>
                                </td>
								<td>
                                    <input type="hidden" class="item_precio" th:value="${detalle.precioUnitario}" /> 
                                    <span class="precio_display" th:text="${#numbers.formatDecimal(detalle.precioUnitario, 1, 'POINT', 2, 'COMMA')}"></span>
                                </td>
								<td>
                                    <input type="number" name="cantidad[]" th:value="${detalle.cantidad}" class="form-control cantidad_input" style="width: 60px;" />
                                </td>
								<td class="total_item" th:text="${#numbers.formatDecimal(detalle.subtotal, 1, 'POINT', 2, 'COMMA')}"></td>
								<td><a href="#" class="btn btn-danger btn-sm" onclick="eliminarItem(this)">X</a></td>
							</tr>
                            
                            <!-- Existing Combos -->
							<tr class="item_row" th:each="detalle : *{detalles}" th:if="${detalle.combo != null}">
								<td>
                                    <input type="hidden" name="combo_id[]" th:value="${detalle.combo.id}" /> 
                                    <span class="badge badge-success">Combo</span> <span th:text="${detalle.combo.nombre}"></span>
                                </td>
                                <td>
                                    <!-- Combos usually don't have dynamic price lists per item in this context, or we disable it -->
                                    <span class="text-muted">-</span>
                                </td>
								<td>
                                    <input type="hidden" class="item_precio" th:value="${detalle.precioUnitario}" /> 
                                    <span class="precio_display" th:text="${#numbers.formatDecimal(detalle.precioUnitario, 1, 'POINT', 2, 'COMMA')}"></span>
                                </td>
								<td>
                                    <input type="number" name="combo_cantidad[]" th:value="${detalle.cantidad}" class="form-control cantidad_input" style="width: 60px;" />
                                </td>
								<td class="total_item" th:text="${#numbers.formatDecimal(detalle.subtotal, 1, 'POINT', 2, 'COMMA')}"></td>
								<td><a href="#" class="btn btn-danger btn-sm" onclick="eliminarItem(this)">X</a></td>
							</tr>
                        </tbody>
                    </table>

                    <h5>Total: <span id="total_venta">0.00</span></h5>

	                 <div class="box-footer"> 
	                     <input type="submit" value="Guardar Venta" class="btn btn-primary">
	                     <a th:href="@{/}" class="btn btn-primary">Cancelar</a>
	                 </div>
	              </form>
	           </div>
	      </div>
	   
	   </div>
	</div>
	
	<footer th:replace="layout/layout :: footer"></footer>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        let totalVenta = 0;

        function mostrarClienteSeleccionado() {
            $("#buscar_cliente").addClass("is-valid");
            $("#cliente_seleccionado_msg").show();
        }

        function resetClienteSeleccionado() {
            $("#buscar_cliente").removeClass("is-valid");
            $("#cliente_seleccionado_msg").hide();
            $("#clienteId").val(""); 
        }

        $(document).ready(function() {
            if ($("#clienteId").val()) {
                mostrarClienteSeleccionado();
            }

            $("#buscar_cliente").on("input", function() {
                resetClienteSeleccionado();
            });

            $("#btn_buscar_cliente").on("click", function() {
                let searchTerm = $("#buscar_cliente").val();
                if (searchTerm.length < 1) {
                    $("#resultados_busqueda_cliente").html("<p>Ingrese al menos 1 caracter para buscar.</p>");
                    return;
                }

                $.ajax({
                    url: /*[[@{/cargar-clientes}]]*/ "/cargar-clientes",
                    data: { term: searchTerm },
                    dataType: "json",
                    success: function(data) {
                        let resultsHtml = "";
                        if (data.length > 0) {
                            resultsHtml += "<ul class=\"list-group\">";
                            $.each(data, function(index, item) {
                                let fullName = item.nombre + (item.apellido ? " " + item.apellido : "");
                                resultsHtml += "<li class=\"list-group-item\" data-id=\"" + item.id + "\" data-nombre=\"" + fullName + "\">";
                                resultsHtml += fullName + "</li>";
                            });
                            resultsHtml += "</ul>";
                        } else {
                            resultsHtml += "<p>No se encontraron clientes.</p>";
                        }
                        $("#resultados_busqueda_cliente").html(resultsHtml);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error loading clients:", xhr, status, error);
                        $("#resultados_busqueda_cliente").html("<p>Error al cargar clientes. Intente de nuevo.</p>");
                    }
                });
            });

            $("#resultados_busqueda_cliente").on("click", ".list-group-item", function() {
                let clienteId = $(this).data("id");
                let clienteNombre = $(this).data("nombre");

                $("#clienteId").val(clienteId);
                $("#buscar_cliente").val(clienteNombre);
                mostrarClienteSeleccionado();
                $("#resultados_busqueda_cliente").empty(); 
            });

            calcularTotal();
            
            // --- BUSQUEDA UNIFICADA ---
            $("#btn_buscar_producto").on("click", function() {
                let searchTerm = $("#buscar_producto").val();
                if (searchTerm.length < 1) {
                    $("#resultados_busqueda").html("<p>Ingrese al menos 1 caracter para buscar.</p>");
                    return;
                }
                
                // Usar la primera lista del template como referencia por defecto si no hay global
                let listaPrecioId = $("#listaPrecioTemplate option:first").val();

                // Llamadas paralelas a vinos y combos
                let requestVinos = $.ajax({
                    url: /*[[@{/cargar-vinos}]]*/ "/cargar-vinos",
                    data: { term: searchTerm },
                    dataType: "json"
                });

                let requestCombos = $.ajax({
                    url: /*[[@{/cargar-combos}]]*/ "/cargar-combos",
                    data: { term: searchTerm },
                    dataType: "json"
                });

                $.when(requestVinos, requestCombos).done(function(vinosResponse, combosResponse) {
                    // vinosResponse[0] contiene los datos, vinosResponse[1] el estado, etc.
                    // Si falla una de las dos, jQuery puede comportarse distinto, pero asumiremos exito
                    // Nota: si una de las listas viene vacia, a veces la respuesta cambia.
                    
                    // Normalizar respuestas (pueden ser array directo o [array, status, xhr])
                    let vinos = (vinosResponse && vinosResponse[0]) ? vinosResponse[0] : [];
                    let combos = (combosResponse && combosResponse[0]) ? combosResponse[0] : [];
                    
                    // Si la respuesta vino directa (sin array wrapper de $.when para single request), ajustar
                    // Pero $.when siempre devuelve array arguments para cada request.
                    
                    let resultsHtml = "";
                    if (vinos.length > 0 || combos.length > 0) {
                        resultsHtml += "<ul class=\"list-group\">";
                        
                        // Renderizar Vinos
                        $.each(vinos, function(index, item) {
                            resultsHtml += `<li class="list-group-item product-item" data-type="vino" data-id="${item.id}" data-nombre="${item.nombre}">
                                                <span class="badge badge-primary">Vino</span> ${item.nombre}
                                            </li>`;
                        });

                        // Renderizar Combos
                        $.each(combos, function(index, item) {
                            resultsHtml += `<li class="list-group-item product-item" data-type="combo" data-id="${item.id}" data-nombre="${item.nombre}" data-precio="${item.precio}">
                                                <span class="badge badge-success">Combo</span> ${item.nombre} - $${item.precio}
                                            </li>`;
                        });

                        resultsHtml += "</ul>";
                    } else {
                        resultsHtml += "<p>No se encontraron productos.</p>";
                    }
                    $("#resultados_busqueda").html(resultsHtml);

                }).fail(function() {
                     // Si falla (ej. uno da error), intentar mostrar lo que se pueda o error
                     // Simplificacion: mostrar error
                     $("#resultados_busqueda").html("<p>Error al buscar productos. Intente de nuevo.</p>");
                });
            });

            $("#resultados_busqueda").on("click", ".product-item", function() {
                let type = $(this).data("type");
                let id = $(this).data("id");
                let nombre = $(this).data("nombre");
                // Usar la primera lista del template como referencia por defecto
                let listaPrecioId = $("#listaPrecioTemplate option:first").val();
                
                // Si es Vino, necesitamos buscar el precio
                if (type === "vino") {
                     $.ajax({
                        url: "/obtener-precio?vinoId=" + id + "&listaPrecioId=" + listaPrecioId,
                        dataType: "json",
                        success: function(precio) {
                            agregarFila(type, id, nombre, precio, listaPrecioId);
                        }
                    });
                } else {
                    // Si es Combo, el precio ya viene en el data-precio
                    let precio = parseFloat($(this).data("precio"));
                    agregarFila(type, id, nombre, precio, null);
                }
                
                $("#resultados_busqueda").empty();
                $("#buscar_producto").val("");
            });

            $("#items_venta").on("change", ".cantidad_input", function() {
                let cantidad = $(this).val();
                let precio = parseFloat($(this).closest("tr").find(".item_precio").val());
                
                let totalItem = cantidad * precio;
                $(this).closest("tr").find(".total_item").text(totalItem.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                calcularTotal();
            });
            
            // --- EVENTO CAMBIO LISTA PRECIO POR ITEM ---
            $("#items_venta").on("change", ".lista_precio_item_select", function() {
                let tr = $(this).closest("tr");
                let listaPrecioId = $(this).val();
                let vinoIdInput = tr.find("input[name='item_id[]']");
                
                // Solo si es un vino (tiene input item_id)
                if (vinoIdInput.length > 0) {
                    let vinoId = vinoIdInput.val();
                    $.ajax({
                        url: "/obtener-precio?vinoId=" + vinoId + "&listaPrecioId=" + listaPrecioId,
                        dataType: "json",
                        success: function(precio) {
                             tr.find(".item_precio").val(precio);
                             tr.find(".precio_display").text(precio.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                             
                             // Recalcular subtotal
                             let cantidad = tr.find(".cantidad_input").val();
                             let totalItem = cantidad * precio;
                             tr.find(".total_item").text(totalItem.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                             
                             calcularTotal();
                        }
                    });
                }
            });
        });

        function agregarFila(type, id, nombre, precio, listaPrecioId) {
            let precioFormatted = precio.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            let row = `<tr class="item_row">`;
            
            if (type === "vino") {
                row += `<td>
                            <input type="hidden" name="item_id[]" value="${id}">
                            <span class="badge badge-primary">Vino</span> ${nombre}
                        </td>`;
                
                // Clone select
                let $select = $("#listaPrecioTemplate").clone();
                $select.attr("id", ""); // remove id
                $select.attr("name", "lista_precio_item[]");
                $select.show(); // ensure it is visible
                if (listaPrecioId) {
                    $select.val(listaPrecioId);
                }
                // Convert to HTML string
                let selectHtml = $select.prop('outerHTML');
                
                row += `<td>${selectHtml}</td>`;
                
                row += `<td><input type="hidden" class="item_precio" value="${precio}"><span class="precio_display">${precioFormatted}</span></td>`;
                row += `<td><input type="number" name="cantidad[]" value="1" class="form-control cantidad_input" style="width: 60px;"/></td>`;
            } else {
                row += `<td>
                            <input type="hidden" name="combo_id[]" value="${id}">
                            <span class="badge badge-success">Combo</span> ${nombre}
                        </td>`;
                row += `<td><span class="text-muted">-</span></td>`;
                row += `<td><input type="hidden" class="item_precio" value="${precio}"><span class="precio_display">${precioFormatted}</span></td>`;
                row += `<td><input type="number" name="combo_cantidad[]" value="1" class="form-control cantidad_input" style="width: 60px;"/></td>`;
            }

            row += `<td class="total_item">${precioFormatted}</td>`;
            row += `<td><a href="#" class="btn btn-danger btn-sm" onclick="eliminarItem(this)">X</a></td>`;
            row += `</tr>`;

            $("#items_venta tbody").append(row);
            calcularTotal();
        }

        function eliminarItem(btn) {
            $(btn).closest("tr").remove();
            calcularTotal();
        }

        function calcularTotal() {
            totalVenta = 0;
            $("#items_venta tbody tr").each(function() {
                let cantidad = parseInt($(this).find(".cantidad_input").val());
                let precio = parseFloat($(this).find(".item_precio").val());
                if (!isNaN(cantidad) && !isNaN(precio)) {
                    totalVenta += cantidad * precio;
                }
            });
            $("#total_venta").text(totalVenta.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        }
    </script>
</body>
</html>